#!/bin/sh

[ "$#" != 2 ] && echo "usage: $0 script.sh binary" && exit
DIR="$(dirname "$0")"
perl -pe "s/SCRIPT_FILE_NAME/$1/g; s/SCRIPT_CONTENT/\`cat '$1'\`/ge" "$DIR/main.cpp" >"$1.cpp" || exit 1
CXX="g++ -fconstexpr-loop-limit=1073741824 -fconstexpr-ops-limit=1073741824"
command -v clang++ >/dev/null 2>&1 && CXX="clang++ -fconstexpr-depth=1073741824 -fconstexpr-steps=1073741824"
$CXX -I"$DIR" -std=c++14 "$1.cpp" -o "$2" || exit 1
strip "$2"
rm -f "$1.cpp"
