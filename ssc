#!/bin/sh

while [ -n "$1" ]; do
  case "$1" in
    -u|--untraceable) CXXFLAGS="$CXXFLAGS -DUNTRACEABLE";;
    -s|--static)      CXXFLAGS="$CXXFLAGS -static -static-libgcc -static-libstdc++";;
    -v|--verbose)     set -x; CXXFLAGS="$CXXFLAGS -v";;
    -h|--help)        SHOW_USAGE=1;;
    -*|--*)           echo "Unknown option $1"; exit 1;;
    *)                POSITIONAL_ARGS="$POSITIONAL_ARGS \"$1\"";;
  esac
  shift
done
eval set -- $POSITIONAL_ARGS
if [ -n "$SHOW_USAGE" -o  $# != 2 ]; then
    echo "Usage: $0 [-u] [-s] <script> <binary>"
    echo "  -u, --untraceable   make untraceable binary"
    echo "  -s, --static        make static binary, more portable but bigger"
    echo "  -v, --verbose       show debug messages"
    echo "  -h, --help          display this help and exit"
    exit 0
fi

case "$(uname -s)" in
    Linux*)       machine=Linux;  CXXFLAGS="$CXXFLAGS -std=c++14";;
    Darwin*)      machine=Mac;    CXXFLAGS="$CXXFLAGS -std=c++14";;
    CYGWIN*)      machine=Cygwin; CXXFLAGS="$CXXFLAGS -std=gnu++14";;
    MINGW*|MSYS*) echo "please use cygwin"; exit 1;;
    *)            echo "unsupported system"; exit 1;;
esac

DIR="$(dirname "$0")"

# generate c++ source code with script code
perl -pe "s|SCRIPT_FILE_NAME|$1|g; s|SCRIPT_CONTENT|\`cat '$1'\`|ge" "$DIR/main.cpp" >"$1.cpp" || exit 1

# compile c++ source code to binary
if g++ -v 2>&1 | grep clang >/dev/null 2>&1; then
  CXXFLAGS="$CXXFLAGS -fconstexpr-depth=1073741824 -fconstexpr-steps=1073741824"
else
  CXXFLAGS="$CXXFLAGS -fconstexpr-loop-limit=1073741824 -fconstexpr-ops-limit=1073741824"
fi
g++ -I"$DIR" $CXXFLAGS "$1.cpp" -o "$2" || exit 1
strip "$2"

# cleanup
rm -f "$1.cpp"
